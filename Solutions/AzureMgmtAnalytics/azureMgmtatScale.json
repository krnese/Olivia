{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "omsWorkspaceName": {
            "type": "string",
            "metadata": {
                "description": "Specify the name of your existing OMS Automation account to store the configuration"
            }
        },
        "omsWorkspaceRegion": {
            "type": "string",
            "metadata": {
                "description": "Specify the region for your OMS workspace"
            }
        },
        "omsAutomationAccountName": {
            "type": "string",
            "metadata": {
                "description": "Specify the name of your Automation Account"
            }
        },
        "omsAutomationRegion": {
            "type": "string",
            "metadata": {
                "description": "Specify region for your automation account"
            }
        },
        "jobGuid": {
            "type": "string",
            "defaultValue": "Use Powershell and run 'New-Guid' to get the GUID",
            "metadata": {
                "description": "GUID for the schedule creation - create a unique before deploy"
            }
        }
    }, 
    "variables": {
        "assets": {
            "psModules": {
                "ingestionAPI": {
                    "name": "OMSIngestionAPI",
                    "uri": "https://github.com/krnese/AzureDeploy/raw/master/OMS/MSOMS/Solutions/custom/OMSIngestionAPI.zip"
                },
                "azureRmProfile": {
                    "name": "AzureRm.Profile",
                    "url": "https://devopsgallerystorage.blob.core.windows.net/packages/azurerm.profile.2.3.0.nupkg"
                },
                "azureRmResources": {
                    "name": "AzureRm.Resources",
                    "url": "https://devopsgallerystorage.blob.core.windows.net/packages/azurerm.resources.3.3.0.nupkg"
                },
                "azureRmRecoveryServices": {
                    "name": "AzureRm.RecoveryServices",
                    "url": "https://devopsgallerystorage.blob.core.windows.net/packages/azurerm.recoveryservices.2.3.0.nupkg"
                },
                "azureRmBackup": {
                    "name": "AzureRM.RecoveryServices.Backup",
                    "url": "https://devopsgallerystorage.blob.core.windows.net/packages/azurerm.recoveryservices.backup.2.3.0.nupkg"
                },
                "azureRmCompute": {
                    "name": "AzureRm.Compute",
                    "url": "https://devopsgallerystorage.blob.core.windows.net/packages/azurerm.compute.2.3.0.nupkg"
                },
                "azureRmAutomation": {
                    "name": "AzureRm.Automation",
                    "url": "https://devopsgallerystorage.blob.core.windows.net/packages/azurerm.automation.2.3.0.nupkg"
                },
                "azureRmInsights": {
                    "name": "AzureRm.Insights",
                    "url": "https://devopsgallerystorage.blob.core.windows.net/packages/azurerm.insights.2.3.0.nupkg"
                }
            },
            "aaVariables": {
                "OMSWorkspaceId": {
                    "name": "OMSWorkspaceId",
                    "description": "Workspace ID for the Log Analytics workspace"
                },
                "OMSWorkspaceKey": {
                    "name": "OMSWorkspaceKey",
                    "description": "Primary key for the Log Analytics workspace"
                },
                "AzureSubscriptionId": {
                    "name": "AzureSubscriptionId",
                    "description": "Azure subscription Id"
                },
                "AzureTenantId": {
                    "name": "AzureTenantId",
                    "description": "Azure tenant id"
                },
                "OMSAutomationAccountName": {
                    "name": "OMSAutomationAccountName",
                    "description": "Name of the linked Automation account"
                },
                "OMSResourceGroupName": {
                    "name": "OMSResourceGroupName",
                    "description": "Name of the Resource Group containing the OMS services"
                }
            },
            "runbooks": {
                "vmManagement": {
                    "name": "azureMgmtAnalytics",
                    "url": "[uri(deployment().properties.templateLink.uri, 'scripts/azureMgmtAnalytics.ps1')]",
                    "version": "1.0.0.0",
                    "type": "PowerShell",
                    "description": "OMS runbook to capture Azure Resources into OMS Log Analytics",
                    "Id": "",
                    "ingestScheduleName": "IngestAPISchedule",
                    "ingestInterval": 1,
                    "ingestFrequency": "hour"
                }
            }
        },
        "omsSolutions": {
            "azureActivity": {
                "name": "AzureActivity",
                "solutionName": "[concat('AzureActivity', '(', parameters('omsWorkspaceName'), ')')]",
                "publisher": "Microsoft"
            },
            "customSolution": {
                "name": "AzureManagementAnalytics",
                "solutionName": "[concat('AzureManagementAnalytics', '[', parameters('omsWorkspaceName'), ']')]",
                "publisher": "krnese@microsoft.com",
                "displayName": "Azure Management Analytics",
                "description": "Management assessment of Azure resources",
                "author": "krnese@microsoft.com"
            }
        }
    },
    "resources": [
        {
            "name": "[parameters('omsWorkspaceName')]",
            "type": "Microsoft.OperationalInsights/workspaces",
            "apiVersion": "2015-11-01-preview",
            "location": "[parameters('omsWorkspaceRegion')]",
            "properties": {
                "sku": {
                    "name": "pernode"
                }
            },
            "resources": [
                {
                    "name": "AzureActivityLog",
                    "type": "datasources",
                    "apiVersion": "2015-11-01-preview",
                    "dependsOn": [
                        "[concat('Microsoft.OperationalInsights/workspaces/', parameters('omsWorkspaceName'))]"
                    ],
                    "kind": "AzureActivityLog",
                    "properties": {
                        "linkedResourceId": "[concat(subscription().id, '/providers/Microsoft.Insights/eventTypes/management')]"
                    }
                },

                {
                    "apiVersion": "2015-11-01-preview",
                    "name": "[variables('omsSolutions').customSolution.name]",
                    "type": "views",
                    "id": "[resourceId('Microsoft.OperationalInsights/workspaces/views/', parameters('omsWorkspaceName'), variables('omsSolutions').customSolution.name)]",
                    "dependson": [
                        "[Concat('Microsoft.OperationalInsights/workspaces/', parameters('omsWorkspaceName'))]"
                    ],
                    "properties": {
                        "Name": "[variables('omsSolutions').customSolution.name]",
                        "DisplayName": "[variables('omsSolutions').customSolution.displayName]",
                        "Description": "[variables('omsSolutions').customSolution.description]",
                        "Author": "[variables('omsSolutions').customSolution.author]",
                        "Source": "Local",
                        "Version": 0,
                        "Dashboard": [
                            {
                                "Id": "SingleQueryDonutBuilderBladeV1",
                                "Type": "Blade",
                                "Version": 0,
                                "Configuration": {
                                    "General": {
                                        "title": "Insights & Analytics",
                                        "newGroup": false,
                                        "icon": "",
                                        "useIcon": false
                                    },
                                    "Header": {
                                        "Title": "IaaS Overview",
                                        "Subtitle": ""
                                    },
                                    "Donut": {
                                        "Query": "AzureManagement_CL | where Log_s == \"IaaS\" | summarize AggregatedValue = dcount(VMName_s) by MgmtStatus_s | sort by AggregatedValue desc | where isnotempty(MgmtStatus_s)",
                                        "CenterLegend": {
                                            "Text": "Total",
                                            "Operation": "Sum",
                                            "ArcsToSelect": []
                                        },
                                        "Options": {
                                            "colors": [
                                                "#55d455",
                                                "#e81123",
                                                "#00bcf2"
                                            ],
                                            "valueColorMapping": [
                                                {
                                                    "value": "Unmanaged",
                                                    "color": "#e81123"
                                                },
                                                {
                                                    "value": "Managed",
                                                    "color": "#55d455"
                                                }
                                            ]
                                        },
                                        "NavigationSelect": {}
                                    },
                                    "List": {
                                        "Query": "AzureManagement_CL | where Log_s == \"IaaS\" and MgmtStatus_s == \"Unmanaged\" | summarize AggregatedValue = dcount(MgmtStatus_s) by VMName_s, ResourceGroupName_s, SubscriptionId | project VMName_s, ResourceGroupName_s, SubscriptionId",
                                        "HideGraph": true,
                                        "enableSparklines": false,
                                        "ColumnsTitle": {
                                            "Name": "Unmanaged VMs",
                                            "Value": ""
                                        },
                                        "Color": "#0072c6",
                                        "thresholds": {
                                            "isEnabled": false,
                                            "values": [
                                                {
                                                    "name": "Normal",
                                                    "threshold": "Default",
                                                    "color": "#009e49",
                                                    "isDefault": true
                                                },
                                                {
                                                    "name": "Warning",
                                                    "threshold": "60",
                                                    "color": "#fcd116",
                                                    "isDefault": false
                                                },
                                                {
                                                    "name": "Error",
                                                    "threshold": "90",
                                                    "color": "#ba141a",
                                                    "isDefault": false
                                                }
                                            ]
                                        },
                                        "NameDSVSeparator": "",
                                        "NavigationQuery": "search {selected item}// Oql: {selected item}",
                                        "NavigationSelect": {}
                                    }
                                }
                            },
                            {
                                "Id": "SingleQueryDonutBuilderBladeV1",
                                "Type": "Blade",
                                "Version": 0,
                                "Configuration": {
                                    "General": {
                                        "title": "",
                                        "newGroup": false,
                                        "icon": "",
                                        "useIcon": false
                                    },
                                    "Header": {
                                        "Title": "PaaS Overview",
                                        "Subtitle": ""
                                    },
                                    "Donut": {
                                        "Query": "AzureManagement_CL | where Log_s == \"PaaS\" | summarize AggregatedValue = dcount(ResourceName_s) by MgmtStatus_s | sort by AggregatedValue desc// Oql: Type:AzureManagement_CL Log_s:PaaS | measure countdistinct (ResourceName_s) by MgmtStatus_s",
                                        "CenterLegend": {
                                            "Text": "Total",
                                            "Operation": "Sum",
                                            "ArcsToSelect": []
                                        },
                                        "Options": {
                                            "colors": [
                                                "#55d455",
                                                "#e81123",
                                                "#00bcf2"
                                            ],
                                            "valueColorMapping": [
                                                {
                                                    "value": "Managed",
                                                    "color": "#55d455"
                                                },
                                                {
                                                    "value": "Unmanaged",
                                                    "color": "#e81123"
                                                }
                                            ]
                                        },
                                        "NavigationSelect": {}
                                    },
                                    "List": {
                                        "Query": "AzureManagement_CL | where Log_s == \"PaaS\" and MgmtStatus_s == \"Unmanaged\" | summarize AggregatedValue = count() by ResourceName_s, ResourceType, SubscriptionId | project ResourceName_s, ResourceType, SubscriptionId | project ResourceName_s, ResourceType// Oql: Type:AzureManagement_CL Log_s:PaaS MgmtStatus_s:Unmanaged | measure count () by ResourceName_s, ResourceType | Select ResourceName_s, ResourceType | select ResourceName_s, ResourceType",
                                        "HideGraph": true,
                                        "enableSparklines": false,
                                        "ColumnsTitle": {
                                            "Name": "Unmanaged Resources",
                                            "Value": ""
                                        },
                                        "Color": "#0072c6",
                                        "thresholds": {
                                            "isEnabled": false,
                                            "values": [
                                                {
                                                    "name": "Normal",
                                                    "threshold": "Default",
                                                    "color": "#009e49",
                                                    "isDefault": true
                                                },
                                                {
                                                    "name": "Warning",
                                                    "threshold": "60",
                                                    "color": "#fcd116",
                                                    "isDefault": false
                                                },
                                                {
                                                    "name": "Error",
                                                    "threshold": "90",
                                                    "color": "#ba141a",
                                                    "isDefault": false
                                                }
                                            ]
                                        },
                                        "NameDSVSeparator": "",
                                        "NavigationQuery": "search {selected item}// Oql: {selected item}",
                                        "NavigationSelect": {}
                                    }
                                }
                            },
                            {
                                "Id": "TwoNumberTileListBuilderBlade",
                                "Type": "Blade",
                                "Version": 0,
                                "Configuration": {
                                    "General": {
                                        "title": "Automation & Control",
                                        "newGroup": false,
                                        "icon": "",
                                        "useIcon": false
                                    },
                                    "Tile": {
                                        "Legend": "DSC Nodes",
                                        "Query": "AzureManagement_CL | where Log_s == \"DSC\" | summarize AggregatedValue = dcount(VMName_s) by VMName_s\r\n| count // Oql: Type:AzureManagement_CL Log_s:DSC | measure countdistinct (VMName_s) by VMName_s"
                                    },
                                    "SecondTile": {
                                        "Legend": "Automation Accounts",
                                        "Query": "AzureManagement_CL | where Log_s == \"DSC\" | summarize AggregatedValue = dcount(AutomationAccountName_s) by AutomationAccountName_s\r\n| count // Oql: Type:AzureManagement_CL Log_s:DSC | measure countdistinct (AutomationAccountName_s) by AutomationAccountName_s"
                                    },
                                    "List": {
                                        "Query": "AzureManagement_CL | where Log_s == \"DSC\" and MgmtStatus_s == \"Managed\" | summarize AggregatedValue = dcount(VMName_s) by VMName_s, NodeConfigurationName_s, Status_s | project VMName_s, NodeConfigurationName_s, Status_s\r\n// Oql: Type:AzureManagement_CL Log_s:DSC MgmtStatus_s:Managed | measure countdistinct (VMName_s) by VMName_s, NodeConfigurationName_s, Status_s | Select VMName_s, NodeConfigurationName_s, Status_s",
                                        "HideGraph": true,
                                        "enableSparklines": false,
                                        "operation": "Summary",
                                        "ColumnsTitle": {
                                            "Name": "Node Name",
                                            "Value": ""
                                        },
                                        "Color": "#0072c6",
                                        "thresholds": {
                                            "isEnabled": false,
                                            "values": [
                                                {
                                                    "name": "Normal",
                                                    "threshold": "Default",
                                                    "color": "#009e49",
                                                    "isDefault": true
                                                },
                                                {
                                                    "name": "Warning",
                                                    "threshold": "60",
                                                    "color": "#fcd116",
                                                    "isDefault": false
                                                },
                                                {
                                                    "name": "Error",
                                                    "threshold": "90",
                                                    "color": "#ba141a",
                                                    "isDefault": false
                                                }
                                            ]
                                        },
                                        "NameDSVSeparator": "",
                                        "NavigationQuery": "search {selected item}\r\n// Oql: {selected item}",
                                        "NavigationSelect": {}
                                    },
                                    "Blade": {
                                        "NavigationSelect": {}
                                    }
                                }
                            },
                            {
                                "Id": "SingleQueryDonutBuilderBladeV1",
                                "Type": "Blade",
                                "Version": 0,
                                "Configuration": {
                                    "General": {
                                        "title": "Protection & Recovery",
                                        "newGroup": false,
                                        "icon": "",
                                        "useIcon": false
                                    },
                                    "Header": {
                                        "Title": "IaaS Protection Status",
                                        "Subtitle": ""
                                    },
                                    "Donut": {
                                        "Query": "AzureManagement_CL | where Log_s == \"Backup\" | summarize AggregatedValue = dcount(VMName_s) by ProtectionStatus_s | sort by AggregatedValue desc// Oql: Type:AzureManagement_CL Log_s:Backup | measure countdistinct (VMName_s) by ProtectionStatus_s",
                                        "CenterLegend": {
                                            "Text": "Total",
                                            "Operation": "Sum",
                                            "ArcsToSelect": []
                                        },
                                        "Options": {
                                            "colors": [
                                                "#e81123",
                                                "#55d455",
                                                "#00bcf2"
                                            ],
                                            "valueColorMapping": []
                                        },
                                        "NavigationSelect": {}
                                    },
                                    "List": {
                                        "Query": "AzureManagement_CL | where ProtectionStatus_s == \"Unprotected\" and Log_s == \"Backup\" | project VMName_s, SubscriptionId, Location_s | summarize AggregatedValue = dcount(VMName_s) by VMName_s, Location_s, SubscriptionId // Oql: Type:AzureManagement_CL ProtectionStatus_s:Unprotected LogType_s:Backup | measure countdistinct (VMName_s) by VMName_s | select VMName_s",
                                        "HideGraph": true,
                                        "enableSparklines": false,
                                        "ColumnsTitle": {
                                            "Name": "Unprotected VMs",
                                            "Value": ""
                                        },
                                        "Color": "#0072c6",
                                        "thresholds": {
                                            "isEnabled": false,
                                            "values": [
                                                {
                                                    "name": "Normal",
                                                    "threshold": "Default",
                                                    "color": "#009e49",
                                                    "isDefault": true
                                                },
                                                {
                                                    "name": "Warning",
                                                    "threshold": "60",
                                                    "color": "#fcd116",
                                                    "isDefault": false
                                                },
                                                {
                                                    "name": "Error",
                                                    "threshold": "90",
                                                    "color": "#ba141a",
                                                    "isDefault": false
                                                }
                                            ]
                                        },
                                        "NameDSVSeparator": "",
                                        "NavigationQuery": "search {selected item}// Oql: {selected item}",
                                        "NavigationSelect": {}
                                    }
                                }
                            },
                            {
                                "Id": "SingleQueryDonutBuilderBladeV1",
                                "Type": "Blade",
                                "Version": 0,
                                "Configuration": {
                                    "General": {
                                        "title": "",
                                        "newGroup": false,
                                        "icon": "",
                                        "useIcon": false
                                    },
                                    "Header": {
                                        "Title": "HA/DR Status of Azure Resources",
                                        "Subtitle": ""
                                    },
                                    "Donut": {
                                        "Query": "AzureManagement_CL | where (Log_s == \"IaaS\" or Log_s == \"Storage\") | summarize AggregatedValue = dcount(ResourceId) by AvailabilityStatus_s | sort by AggregatedValue desc// Oql: Type:AzureManagement_CL AND (Log_s=IaaS OR Log_s:Storage)  | measure countdistinct (ResourceId) by AvailabilityStatus_s",
                                        "CenterLegend": {
                                            "Text": "Total",
                                            "Operation": "Sum",
                                            "ArcsToSelect": []
                                        },
                                        "Options": {
                                            "colors": [
                                                "#00188f",
                                                "#0072c6",
                                                "#00bcf2"
                                            ],
                                            "valueColorMapping": [
                                                {
                                                    "value": "Not Highly Available",
                                                    "color": "#e81123"
                                                },
                                                {
                                                    "value": "Highly Available",
                                                    "color": "#55d455"
                                                }
                                            ]
                                        },
                                        "NavigationSelect": {}
                                    },
                                    "List": {
                                        "Query": "AzureManagement_CL | where (Log_s == \"IaaS\" or Log_s == \"Storage\") and AvailabilityStatus_s == \"Not Highly Available\" | summarize AggregatedValue = count() by ResourceId, ResourceGroupName_s, AvailabilityStatus_s | project ResourceId, ResourceGroupName_s, AvailabilityStatus_s// Oql: Type:AzureManagement_CL AND (Log_s=IaaS OR Log_s:Storage) AvailabilityStatus_s:\"Not Highly Available\" | measure count () by ResourceId, ResourceGroupName_s, AvailabilityStatus_s | select ResourceId, ResourceGroupName_s, AvailabilityStatus_s",
                                        "HideGraph": true,
                                        "enableSparklines": false,
                                        "ColumnsTitle": {
                                            "Name": "ResourceId",
                                            "Value": ""
                                        },
                                        "Color": "#0072c6",
                                        "thresholds": {
                                            "isEnabled": false,
                                            "values": [
                                                {
                                                    "name": "Normal",
                                                    "threshold": "Default",
                                                    "color": "#009e49",
                                                    "isDefault": true
                                                },
                                                {
                                                    "name": "Warning",
                                                    "threshold": "60",
                                                    "color": "#fcd116",
                                                    "isDefault": false
                                                },
                                                {
                                                    "name": "Error",
                                                    "threshold": "90",
                                                    "color": "#ba141a",
                                                    "isDefault": false
                                                }
                                            ]
                                        },
                                        "NameDSVSeparator": "",
                                        "NavigationQuery": "search {selected item}// Oql: {selected item}",
                                        "NavigationSelect": {}
                                    }
                                }
                            },
                            {
                                "Id": "SingleQueryDonutBuilderBladeV1",
                                "Type": "Blade",
                                "Version": 0,
                                "Configuration": {
                                    "General": {
                                        "title": "Azure Resource Manager",
                                        "newGroup": false,
                                        "icon": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACUAAAAhCAYAAABeD2IVAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAG1SURBVFhH7ZbPSwJREID7ZzZsE5VyNU0wDAulQDYwOwQdEsPs1iJIZBB0qFtREKSHQgj0JB07FXQJPNTJQ0dv/Q9TM/Hk+WOXt8VaxDt8sMzODB8yzuyYoijw15BSokgpUf6XlKZpA7Fxt5fojw/LtcK2VDgchmw2C/l8vifuyRRg5vSe8Kxu97zDXKzBWj5uhi2pVCoFhmFAPB7vxtTYMgSOmxC6fOpBO7yldywvmUxSLfZgMTNsSZVKJVBVlZ5d/hD496oDMv1MG2eUizVYiz34nsOwLcWecXZ8uYOhIjyYw8+ZY1LeuUWI75+Dy+Mz/cUwNjE7D14tAMWrOtXwPaz4ltRUQoe1uzak6y2IFsoUw/kJnjSJyUSGYrmjU6i9dKDRfqcavocVP5Ji6NcPoOnr3byljS2oPL+RDGPkUozI5i7By/y6VHSnTEgp1tAdjMDKzaOwVPVzvrCG72GFbSm2PBGcn3SjZSpVe+3QP5DlO7I82ZnBk8FiuKsWyhcDUsVKg3YUy3PszCBmBxmXI84NEtO/9hTD0YPMY+dzxPFPl1EgpUSRUqJIKVGklChSSgwFPgAtyp8CCywroQAAAABJRU5ErkJggg==",
                                        "useIcon": false
                                    },
                                    "Header": {
                                        "Title": "Deployment Overview",
                                        "Subtitle": ""
                                    },
                                    "Donut": {
                                        "Query": "AzureManagement_CL | where Log_s == \"Deployments\" | summarize AggregatedValue = dcount(CorrelationId) by ProvisioningState_s | sort by AggregatedValue desc | where isnotempty(ProvisioningState_s)  // Oql: Type:AzureManagement_CL Log_s:Deployments | measure countdistinct (CorrelationId) by ProvisioningState_s",
                                        "CenterLegend": {
                                            "Text": "Total",
                                            "Operation": "Sum",
                                            "ArcsToSelect": []
                                        },
                                        "Options": {
                                            "colors": [
                                                "#00188f",
                                                "#0072c6",
                                                "#00bcf2"
                                            ],
                                            "valueColorMapping": [
                                                {
                                                    "value": "Succeeded",
                                                    "color": "#55d455"
                                                },
                                                {
                                                    "value": "Failed",
                                                    "color": "#e81123"
                                                },
                                                {
                                                    "value": "Canceled",
                                                    "color": "#00188f"
                                                }
                                            ]
                                        },
                                        "NavigationSelect": {}
                                    },
                                    "List": {
                                        "Query": "AzureManagement_CL | where Log_s == \"Deployments\" and (ProvisioningState_s == \"Failed\" or ProvisioningState_s == \"Canceled\") | summarize AggregatedValue = count() by DeploymentName_s, ResourceGroupName_s, ProvisioningState_s | project DeploymentName_s, ResourceGroupName_s, ProvisioningState_s// Oql: Type:AzureManagement_CL Log_s:Deployments AND (ProvisioningState_s:Failed OR ProvisioningState_s:Canceled) | measure count () by DeploymentName_s, ResourceGroupName_s, ProvisioningState_s | select DeploymentName_s, ResourceGroupName_s, ProvisioningState_s",
                                        "HideGraph": true,
                                        "enableSparklines": false,
                                        "operation": "Summary",
                                        "ColumnsTitle": {
                                            "Name": "Deployment Name",
                                            "Value": ""
                                        },
                                        "Color": "#0072c6",
                                        "thresholds": {
                                            "isEnabled": false,
                                            "values": [
                                                {
                                                    "name": "Normal",
                                                    "threshold": "Default",
                                                    "color": "#009e49",
                                                    "isDefault": true
                                                },
                                                {
                                                    "name": "Warning",
                                                    "threshold": "60",
                                                    "color": "#fcd116",
                                                    "isDefault": false
                                                },
                                                {
                                                    "name": "Error",
                                                    "threshold": "90",
                                                    "color": "#ba141a",
                                                    "isDefault": false
                                                }
                                            ]
                                        },
                                        "NameDSVSeparator": "",
                                        "NavigationQuery": "search {selected item}// Oql: {selected item}",
                                        "NavigationSelect": {}
                                    }
                                }
                            },
                            {
                                "Id": "TwoNumberTileListBuilderBlade",
                                "Type": "Blade",
                                "Version": 0,
                                "Configuration": {
                                    "General": {
                                        "title": "Resource Overview",
                                        "newGroup": false,
                                        "icon": "",
                                        "useIcon": false
                                    },
                                    "Tile": {
                                        "Legend": "Resources in total",
                                        "Query": "AzureManagement_CL | where Log_s == \"Resources\" | summarize AggregatedValue = dcount(ResourceId) by ResourceName_s\r\n| count // Oql: Type:AzureManagement_CL Log_s:Resources | measure countdistinct (ResourceId) by ResourceName_s"
                                    },
                                    "SecondTile": {
                                        "Legend": "Resource Types",
                                        "Query": "AzureManagement_CL | where Log_s == \"Resources\" | summarize AggregatedValue = count() by ResourceType\r\n| count // Oql: Type:AzureManagement_CL Log_s:Resources | measure count () by ResourceType"
                                    },
                                    "List": {
                                        "Query": "AzureManagement_CL | where Log_s == \"Resources\" | summarize AggregatedValue = dcount(ResourceId) by ResourceType\r\n// Oql: Type:AzureManagement_CL Log_s:Resources | measure countdistinct (ResourceId) by ResourceType",
                                        "HideGraph": false,
                                        "enableSparklines": false,
                                        "operation": "Summary",
                                        "ColumnsTitle": {
                                            "Name": "Most used resource types",
                                            "Value": "Count"
                                        },
                                        "Color": "#0072c6",
                                        "thresholds": {
                                            "isEnabled": false,
                                            "values": [
                                                {
                                                    "name": "Normal",
                                                    "threshold": "Default",
                                                    "color": "#009e49",
                                                    "isDefault": true
                                                },
                                                {
                                                    "name": "Warning",
                                                    "threshold": "60",
                                                    "color": "#fcd116",
                                                    "isDefault": false
                                                },
                                                {
                                                    "name": "Error",
                                                    "threshold": "90",
                                                    "color": "#ba141a",
                                                    "isDefault": false
                                                }
                                            ]
                                        },
                                        "NameDSVSeparator": "",
                                        "NavigationQuery": "search {selected item}\r\n// Oql: {selected item}",
                                        "NavigationSelect": {}
                                    },
                                    "Blade": {
                                        "NavigationSelect": {}
                                    }
                                }
                            },
                            {
                                "Id": "TwoNumberTileListBuilderBlade",
                                "Type": "Blade",
                                "Version": 0,
                                "Configuration": {
                                    "General": {
                                        "title": "RBAC Overview",
                                        "newGroup": false,
                                        "icon": "",
                                        "useIcon": false
                                    },
                                    "Tile": {
                                        "Legend": "Total User Roles",
                                        "Query": "AzureManagement_CL | where Log_s == \"RBAC\" | summarize AggregatedValue = dcount(RoleDefinitionId_g) by Name_s| count // Oql: Type:AzureManagement_CL Log_s:RBAC | measure countdistinct (RoleDefinitionId_g) by DisplayName_s"
                                    },
                                    "SecondTile": {
                                        "Legend": "Resources with assigned RBAC",
                                        "Query": "AzureManagement_CL | where Log_s == \"RBAC\" and Scope_s != \"/subscriptions/09e8ed26-7d8b-4678-a179-cfca8a0cef5c\" | summarize AggregatedValue = dcount(RoleDefinitionId_g) by DisplayName_s, Scope_s| count // Oql: Type:AzureManagement_CL Log_s:RBAC !Scope_s:\"/subscriptions/09e8ed26-7d8b-4678-a179-cfca8a0cef5c\" | measure countdistinct (RoleDefinitionId_g) by DisplayName_s, Scope_s"
                                    },
                                    "List": {
                                        "Query": "AzureManagement_CL | where Log_s == \"RBAC\" and Scope_s != \"/subscriptions/09e8ed26-7d8b-4678-a179-cfca8a0cef5c\" | summarize AggregatedValue = dcount(RoleDefinitionId_g) by DisplayName_s, Scope_s | project DisplayName_s, Scope_s// Oql: Type:AzureManagement_CL Log_s:RBAC !Scope_s:\"/subscriptions/09e8ed26-7d8b-4678-a179-cfca8a0cef5c\" | measure countdistinct (RoleDefinitionId_g) by DisplayName_s, Scope_s | select DisplayName_s, Scope_s",
                                        "HideGraph": true,
                                        "enableSparklines": false,
                                        "operation": "Summary",
                                        "ColumnsTitle": {
                                            "Name": "Assigned User Roles",
                                            "Value": ""
                                        },
                                        "Color": "#0072c6",
                                        "thresholds": {
                                            "isEnabled": false,
                                            "values": [
                                                {
                                                    "name": "Normal",
                                                    "threshold": "Default",
                                                    "color": "#009e49",
                                                    "isDefault": true
                                                },
                                                {
                                                    "name": "Warning",
                                                    "threshold": "60",
                                                    "color": "#fcd116",
                                                    "isDefault": false
                                                },
                                                {
                                                    "name": "Error",
                                                    "threshold": "90",
                                                    "color": "#ba141a",
                                                    "isDefault": false
                                                }
                                            ]
                                        },
                                        "NameDSVSeparator": "",
                                        "NavigationQuery": "search {selected item}// Oql: {selected item}",
                                        "NavigationSelect": {}
                                    },
                                    "Blade": {
                                        "NavigationSelect": {}
                                    }
                                }
                            },
                            {
                                "Id": "NumberTileListBuilderBlade",
                                "Type": "Blade",
                                "Version": 0,
                                "Configuration": {
                                    "General": {
                                        "title": "Policy Overview",
                                        "newGroup": false,
                                        "icon": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFEAAAAjCAYAAADsZeb8AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAM5SURBVGhD7ZjLaxNBGMD9Z5LGpmn6SJP0RQRBFFqb1lw8hFTR9mAfIKZ6EOtBFOtFY0Cr0gYvSsEHpSpqWwNC0D9Bcuupp556yuUz3zRfmJ2d7CtTtM0EfmR25ptd9rffzOzOCZ/PB5rm0BIVoCUqQEtUgJaoAC1RAZ4knhw8DZHbK4xApF8a00q4kujvCEP37EPoXy5B7NE6xHNbrNw1tcjaZH1aAUcSUVA4k61K22TiwpkFVndQv8Dq4vkfEDwzIe1/3LGVGBq/DNGldZZxPXNL0ozDId17/TEE4qdMba2ApcS+e2+ZPLdz39jyFxh58k7adhyxlMjmu+m70jaRgcwcJGYWWTn56juMPv1oijksSqUSlMvlenl3dxfS6bQp7rCwlYhznljfHonB8NRNGLpyAwKhLmjvjcHFjT+MaGrSFO8EvGm8ef5HYuzgJf4LXEsMRgcg9eZXXdr4yha0BUNw7kEBxp5/hmAkboh3Ckrc2dmBfD5fP0apKEiMFTlyEhPX7tQFEjiU+Zjki68wkntvqLNDlIisra3V5WB9pVKp5SgY5PISRaHZbBb29/drvQCKxSJ7OHhuisFz7+3tsViqc4N7iTMyifOGmOTLbzCa+2Cos8NKIomgG6cspeNGEsV+eO5CoWASjccIHbvF/XCODVaH8++6wPHVbQh0dMLZ+6tw/tlGdb5UM5x5AeJNIyQYy3w7X+ZjePAaeC28puzhucXTwhLs64fh6VswdDULgc5uttCQ1GjqkineCZRd/I/PNDFTeBGNJMr6Ibw4/jxinFNsJTp+xZmch8TsQexEoVjNyk+mGCusMoIXQzjJRFk/gjKckMU4xVKil5dtv78NLrz+yV64Ze2NsJKIdbioUGZirJM5UeyHxzgnYhmnC7we4nVBISwlIvjZh5sNKBM3Hxp99vU0+dlnJREhIfQjMUgjiWI//OfPj3F8rFdsJSKGjYbcZrWc5TYgahsT+e0jtwGBAvmH4RVHEgmUhpsQmJW4KYHyaN6UZej/DGYkZn4zCwrhSiJxlDdlaT4Vh3YzeJKoMaIlKkBLVICWqAAtUQFaogK0RAVoiQrQEhWgJSpAS2waH/wFQFyL5eOaSbQAAAAASUVORK5CYII=",
                                        "useIcon": false
                                    },
                                    "Tile": {
                                        "Query": "AzureManagement_CL | where Log_s == \"Policy\" | summarize AggregatedValue = dcount(ResourceId) by Name_s, Properties_scope_s| count // Oql: Type:AzureManagement_CL Log_s:Policy | measure countdistinct(ResourceId) by Name_s, Properties_scope_s",
                                        "Legend": "Assigned ARM Policies",
                                        "NavigationSelect": {}
                                    },
                                    "List": {
                                        "Query": "AzureManagement_CL | where Log_s == \"Policy\" | summarize AggregatedValue = dcount(ResourceId) by Name_s, Properties_scope_s | project Name_s, Properties_scope_s// Oql: Type:AzureManagement_CL Log_s:Policy | measure countdistinct(ResourceId) by Name_s, Properties_scope_s | Select Name_s, Properties_scope_s",
                                        "HideGraph": true,
                                        "enableSparklines": false,
                                        "operation": "Summary",
                                        "ColumnsTitle": {
                                            "Name": "Policy Name",
                                            "Value": ""
                                        },
                                        "Color": "#0072c6",
                                        "thresholds": {
                                            "isEnabled": false,
                                            "values": [
                                                {
                                                    "name": "Normal",
                                                    "threshold": "Default",
                                                    "color": "#009e49",
                                                    "isDefault": true
                                                },
                                                {
                                                    "name": "Warning",
                                                    "threshold": "60",
                                                    "color": "#fcd116",
                                                    "isDefault": false
                                                },
                                                {
                                                    "name": "Error",
                                                    "threshold": "90",
                                                    "color": "#ba141a",
                                                    "isDefault": false
                                                }
                                            ]
                                        },
                                        "NameDSVSeparator": "",
                                        "NavigationQuery": "search {selected item}// Oql: {selected item}",
                                        "NavigationSelect": {}
                                    }
                                }
                            },
                            {
                                "Id": "NumberTileListBuilderBlade",
                                "Type": "Blade",
                                "Version": 0,
                                "Configuration": {
                                    "General": {
                                        "title": "Resource Lock Overview",
                                        "newGroup": false,
                                        "icon": "",
                                        "useIcon": false
                                    },
                                    "Tile": {
                                        "Query": "AzureManagement_CL | where Log_s == \"Lock\" | summarize AggregatedValue = dcount(LockId_s) by ResourceType, ResourceName_s\r\n| count // Oql: Type:AzureManagement_CL Log_s:Lock | measure countdistinct (LockId_s) by ResourceType, ResourceName_s",
                                        "Legend": "Active Resource Locks",
                                        "NavigationSelect": {}
                                    },
                                    "List": {
                                        "Query": "AzureManagement_CL | where Log_s == \"Lock\" | summarize AggregatedValue = dcount(LockId_s) by ResourceName_s, ResourceType | project ResourceName_s, ResourceType\r\n// Oql: Type:AzureManagement_CL Log_s:Lock | measure countdistinct (LockId_s) by ResourceName_s, ResourceType | Select ResourceName_s, ResourceType",
                                        "HideGraph": true,
                                        "enableSparklines": false,
                                        "operation": "Summary",
                                        "ColumnsTitle": {
                                            "Name": "Locked Resource",
                                            "Value": ""
                                        },
                                        "Color": "#0072c6",
                                        "thresholds": {
                                            "isEnabled": false,
                                            "values": [
                                                {
                                                    "name": "Normal",
                                                    "threshold": "Default",
                                                    "color": "#009e49",
                                                    "isDefault": true
                                                },
                                                {
                                                    "name": "Warning",
                                                    "threshold": "60",
                                                    "color": "#fcd116",
                                                    "isDefault": false
                                                },
                                                {
                                                    "name": "Error",
                                                    "threshold": "90",
                                                    "color": "#ba141a",
                                                    "isDefault": false
                                                }
                                            ]
                                        },
                                        "NameDSVSeparator": "",
                                        "NavigationQuery": "search {selected item}\r\n// Oql: {selected item}",
                                        "NavigationSelect": {}
                                    }
                                }
                            },
                            {
                                "Id": "TwoNumberTileListBuilderBlade",
                                "Type": "Blade",
                                "Version": 0,
                                "Configuration": {
                                    "General": {
                                        "title": "Subscription and Region overview",
                                        "newGroup": false,
                                        "icon": "",
                                        "useIcon": false
                                    },
                                    "Tile": {
                                        "Legend": "Subscriptions",
                                        "Query": "AzureManagement_CL | where Log_s == \"Resources\" | summarize AggregatedValue = dcount(SubscriptionId) by SubscriptionId\r\n| count // Oql: Type:AzureManagement_CL Log_s:Resources | measure countdistinct (SubscriptionId) by SubscriptionId"
                                    },
                                    "SecondTile": {
                                        "Legend": "Regions in use",
                                        "Query": "AzureManagement_CL | where Log_s == \"Resources\" | summarize AggregatedValue = dcount(Location_s) by Location_s\r\n| count // Oql: Type:AzureManagement_CL Log_s:Resources | measure countdistinct (Location_s) by Location_s"
                                    },
                                    "List": {
                                        "Query": "AzureManagement_CL | where Log_s == \"Resources\" | summarize AggregatedValue = dcount(ResourceId) by Location_s, SubscriptionId\r\n// Oql: Type:AzureManagement_CL Log_s:Resources | measure countdistinct (ResourceId) by Location_s, SubscriptionId",
                                        "HideGraph": false,
                                        "enableSparklines": false,
                                        "operation": "Summary",
                                        "ColumnsTitle": {
                                            "Name": "Azure Region",
                                            "Value": "Resources"
                                        },
                                        "Color": "#0072c6",
                                        "thresholds": {
                                            "isEnabled": false,
                                            "values": [
                                                {
                                                    "name": "Normal",
                                                    "threshold": "Default",
                                                    "color": "#009e49",
                                                    "isDefault": true
                                                },
                                                {
                                                    "name": "Warning",
                                                    "threshold": "60",
                                                    "color": "#fcd116",
                                                    "isDefault": false
                                                },
                                                {
                                                    "name": "Error",
                                                    "threshold": "90",
                                                    "color": "#ba141a",
                                                    "isDefault": false
                                                }
                                            ]
                                        },
                                        "NameDSVSeparator": "",
                                        "NavigationQuery": "search {selected item}\r\n// Oql: {selected item}",
                                        "NavigationSelect": {}
                                    },
                                    "Blade": {
                                        "NavigationSelect": {}
                                    }
                                }
                            }
                        ],
                        "Filters": [],
                        "OverviewTile": {
                            "Id": "DoubleNumberBuilderTile",
                            "Type": "OverviewTile",
                            "Version": 2,
                            "Configuration": {
                                "TileOne": {
                                    "Legend": "Tenants",
                                    "Query": "AzureManagement_CL | where Log_s == \"IaaS\" |  summarize AggregatedValue = count() by TenantId | count"
                                },
                                "TileTwo": {
                                    "Legend": "Subscriptions",
                                    "Query": "AzureManagement_CL | where Log_s == \"IaaS\" |  summarize AggregatedValue = count() by SubscriptionId | count"
                                },
                                "Advanced": {
                                    "DataFlowVerification": {
                                        "Enabled": false,
                                        "Query": "search *// Oql: *",
                                        "Message": ""
                                    }
                                }
                            }
                        }
                    }
                }
            ]
        },
        {
            "type": "Microsoft.Automation/automationAccounts/providers/diagnosticSettings",
            "name": "[concat(parameters('omsAutomationAccountName'), '/', 'Microsoft.Insights/service')]",
            "apiVersion": "2015-07-01",
            "dependsOn": [
                "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'))]",
                "[concat('Microsoft.OperationalInsights/workspaces/', parameters('omsWorkspaceName'))]"
            ],
            "properties": {
                "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('omsWorkspaceName'))]",
                "logs": [
                    {
                        "category": "JobLogs",
                        "enabled": true
                    },
                    {
                        "category": "JobStreams",
                        "enabled": true
                    }
                ]
            }
        },
        {
            "name": "[parameters('omsAutomationAccountName')]",
            "type": "Microsoft.Automation/automationAccounts",
            "apiVersion": "2015-10-31",
            "location": "[parameters('omsAutomationRegion')]",
            "properties": {
                "sku": {
                    "name": "OMS"
                }
            },
            "resources": [
                {
                    "name": "[variables('assets').aaVariables.OMSWorkspaceId.name]",
                    "type": "variables",
                    "apiVersion": "2015-10-31",
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'))]"
                    ],
                    "tags": {},
                    "properties": {
                        "description": "[variables('assets').aaVariables.OMSWorkspaceId.description]",
                        "value": "[concat('\"',reference(resourceId('Microsoft.OperationalInsights/workspaces/', parameters('omsWorkspaceName')), '2015-11-01-preview').customerId,'\"')]"
                    }
                },
                {
                    "name": "[variables('assets').aaVariables.OMSWorkspaceKey.name]",
                    "type": "variables",
                    "apiVersion": "2015-10-31",
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'))]"
                    ],
                    "tags": {},
                    "properties": {
                        "description": "Remote file for the passphrase",
                        "value": "[concat('\"',listKeys(resourceId('Microsoft.OperationalInsights/workspaces/', parameters('omsWorkspaceName')), '2015-11-01-preview').primarySharedKey,'\"')]"
                    }
                },
                {
                    "name": "[variables('assets').aaVariables.AzureSubscriptionId.name]",
                    "type": "variables",
                    "apiVersion": "2015-10-31",
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'))]"
                    ],
                    "tags": {},
                    "properties": {
                        "description": "[variables('assets').aaVariables.AzureSubscriptionId.description]",
                        "value": "[concat('\"',subscription().subscriptionId,'\"')]"
                    }
                },
                {
                    "name": "[variables('assets').aaVariables.AzureTenantId.name]",
                    "type": "variables",
                    "apiVersion": "2015-10-31",
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'))]"
                    ],
                    "tags": {},
                    "properties": {
                        "description": "[variables('assets').aaVariables.AzureTenantId.description]",
                        "value": "[concat('\"',subscription().tenantId,'\"')]"
                    }
                },                
                {
                    "name": "[variables('assets').aaVariables.OMSAutomationAccountName.name]",
                    "type": "variables",
                    "apiVersion": "2015-10-31",
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'))]"
                    ],
                    "tags": {},
                    "properties": {
                        "description": "[variables('assets').aaVariables.OMSAutomationAccountName.description]",
                        "value": "[concat('\"',parameters('omsAutomationAccountName'),'\"')]"
                    }
                },
                {
                    "name": "[variables('assets').psModules.azureRmProfile.name]",
                    "type": "Modules",
                    "apiVersion": "2015-10-31",
                    "tags": {},
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'))]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/variables/', variables('assets').aaVariables.OMSWorkspaceId.name)]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/variables/', variables('assets').aaVariables.OMSWorkspaceKey.name)]"
                    ],
                    "properties": {
                        "contentLink": {
                            "uri": "[variables('assets').psModules.azureRmProfile.url]"
                        }
                    }
                },
                {
                    "name": "[variables('assets').psModules.azureRmCompute.name]",
                    "type": "Modules",
                    "apiVersion": "2015-10-31",
                    "tags": {},
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'))]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/variables/', variables('assets').aaVariables.OMSWorkspaceId.name)]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/variables/', variables('assets').aaVariables.OMSWorkspaceKey.name)]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/modules/', variables('assets').psModules.azureRmProfile.name)]"
                    ],
                    "properties": {
                        "contentLink": {
                            "uri": "[variables('assets').psModules.azureRmCompute.url]"
                        }
                    }
                },
                {
                    "name": "[variables('assets').psModules.azureRmAutomation.name]",
                    "type": "Modules",
                    "apiVersion": "2015-10-31",
                    "tags": {},
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'))]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/variables/', variables('assets').aaVariables.OMSWorkspaceId.name)]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/variables/', variables('assets').aaVariables.OMSWorkspaceKey.name)]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/modules/', variables('assets').psModules.azureRmProfile.name)]"
                    ],
                    "properties": {
                        "contentLink": {
                            "uri": "[variables('assets').psModules.azureRmAutomation.url]"
                        }
                    }
                },
                {
                    "name": "[variables('assets').psModules.azureRmInsights.name]",
                    "type": "Modules",
                    "apiVersion": "2015-10-31",
                    "tags": {},
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'))]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/variables/', variables('assets').aaVariables.OMSWorkspaceId.name)]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/variables/', variables('assets').aaVariables.OMSWorkspaceKey.name)]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/modules/', variables('assets').psModules.azureRmProfile.name)]"
                    ],
                    "properties": {
                        "contentLink": {
                            "uri": "[variables('assets').psModules.azureRmInsights.url]"
                        }
                    }
                },
                {
                    "name": "[variables('assets').psModules.azureRmBackup.name]",
                    "type": "Modules",
                    "apiVersion": "2015-10-31",
                    "tags": {},
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'))]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/variables/', variables('assets').aaVariables.OMSWorkspaceId.name)]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/variables/', variables('assets').aaVariables.OMSWorkspaceKey.name)]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/modules/', variables('assets').psModules.azureRmProfile.name)]"
                    ],
                    "properties": {
                        "contentLink": {
                            "uri": "[variables('assets').psModules.azureRmBackup.url]"
                        }
                    }
                },
                {
                    "name": "[variables('assets').psModules.azureRmRecoveryServices.name]",
                    "type": "Modules",
                    "apiVersion": "2015-10-31",
                    "tags": {},
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'))]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/variables/', variables('assets').aaVariables.OMSWorkspaceId.name)]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/variables/', variables('assets').aaVariables.OMSWorkspaceKey.name)]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/modules/', variables('assets').psModules.azureRmProfile.name)]"
                    ],
                    "properties": {
                        "contentLink": {
                            "uri": "[variables('assets').psModules.azureRmRecoveryServices.url]"
                        }
                    }
                },
                {
                    "name": "[variables('assets').psModules.azureRmResources.name]",
                    "type": "Modules",
                    "apiVersion": "2015-10-31",
                    "tags": {},
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'))]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/variables/', variables('assets').aaVariables.OMSWorkspaceId.name)]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/variables/', variables('assets').aaVariables.OMSWorkspaceKey.name)]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/modules/', variables('assets').psModules.azureRmProfile.name)]"
                    ],
                    "properties": {
                        "contentLink": {
                            "uri": "[variables('assets').psModules.azureRmResources.url]"
                        }
                    }
                },
                {
                    "name": "[variables('assets').psModules.ingestionAPI.name]",
                    "type": "Modules",
                    "apiVersion": "2015-10-31",
                    "tags": {},
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'))]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/variables/', variables('assets').aaVariables.OMSWorkspaceId.name)]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/variables/', variables('assets').aaVariables.OMSWorkspaceKey.name)]"
                    ],
                    "properties": {
                        "contentLink": {
                            "uri": "[variables('assets').psModules.ingestionAPI.uri]"
                        }
                    }
                },
                {
                    "name": "[variables('assets').runbooks.vmManagement.name]",
                    "type": "runbooks",
                    "apiVersion": "2015-10-31",
                    "location": "[parameters('omsAutomationRegion')]",
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'))]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/modules/', variables('assets').psModules.ingestionAPI.name)]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/modules/', variables('assets').psModules.azureRmRecoveryServices.name)]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/modules/', variables('assets').psModules.azureRmBackup.name)]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/modules/', variables('assets').psModules.azureRmInsights.name)]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/modules/', variables('assets').psModules.azureRmCompute.name)]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/modules/', variables('assets').psModules.azureRmAutomation.name)]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/modules/', variables('assets').psModules.azureRmProfile.name)]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/variables/', variables('assets').aaVariables.OMSWorkspaceId.name)]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/variables/', variables('assets').aaVariables.OMSWorkspaceKey.name)]"
                    ],
                    "properties": {
                        "runbookType": "[variables('assets').runbooks.vmManagement.type]",
                        "logProgress": true,
                        "logVerbose": false,
                        "description": "[variables('assets').runbooks.vmManagement.description]",
                        "publishContentLink": {
                            "uri": "[variables('assets').runbooks.vmManagement.url]",
                            "version": "[variables('assets').runbooks.vmManagement.version]"
                        }
                    }
                },
                {
                    "name": "[concat(parameters('omsAutomationAccountName'), '/', variables('assets').runbooks.vmManagement.ingestScheduleName)]",
                    "type": "microsoft.automation/automationAccounts/schedules",
                    "apiVersion": "2015-10-31",
                    "location": "[parameters('omsAutomationRegion')]",
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'))]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/runbooks/', variables('assets').runbooks.vmManagement.name)]"
                    ],
                    "tags": {},
                    "properties": {
                        "description": "OMS Ingestion API Scheduler",
                        "startTime": "",
                        "isEnabled": true,
                        "interval": "[variables('assets').runbooks.vmManagement.ingestInterval]",
                        "frequency": "[variables('assets').runbooks.vmManagement.ingestFrequency]"
                    }
                },
                {
                    "name": "[concat(parameters('omsAutomationAccountName'), '/', parameters('jobGuid'))]",
                    "type": "microsoft.automation/automationAccounts/jobSchedules",
                    "apiVersion": "2015-10-31",
                    "location": "[parameters('omsWorkspaceRegion')]",
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/schedules/', variables('assets').runbooks.vmManagement.ingestScheduleName)]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/runbooks/', variables('assets').runbooks.vmManagement.name)]",
                        "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'))]"
                    ],
                    "tags": {},
                    "properties": {
                        "schedule": {
                            "name": "[variables('assets').runbooks.vmManagement.ingestScheduleName]"
                        },
                        "runbook": {
                            "name": "[variables('assets').runbooks.vmManagement.name]"
                        }
                    }
                }
            ]
        },
        {
            "name": "[variables('omsSolutions').azureActivity.solutionName]",
            "type": "Microsoft.OperationsManagement/solutions",
            "apiVersion": "2015-11-01-preview",
            "location": "[parameters('omsWorkspaceRegion')]",
            "dependsOn": [
                "[concat('Microsoft.OperationalInsights/workspaces/', parameters('omsWorkspaceName'))]"
            ],
            "plan": {
                "name": "[variables('omsSolutions').azureActivity.solutionName]",
                "product": "[concat('OMSGallery/', variables('omsSolutions').azureActivity.name)]",
                "publisher": "[variables('omsSolutions').azureActivity.publisher]",
                "promotionCode": ""
            },
            "properties": {
                "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('omsWorkspaceName'))]"
            }
        },
        {
            "name": "[variables('omsSolutions').customSolution.solutionName]",
            "type": "Microsoft.OperationsManagement/solutions",
            "apiVersion": "2015-11-01-preview",
            "location": "[parameters('omsWorkspaceRegion')]",
            "dependsOn": [
                "[concat('Microsoft.OperationalInsights/workspaces/', parameters('omsWorkspaceName'))]",
                "[concat('Microsoft.OperationalInsights/workspaces/', parameters('omsWorkspaceName'), '/views/', variables('omsSolutions').customSolution.name)]",
                "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/modules/', variables('assets').psModules.ingestionAPI.name)]",
                "[concat('Microsoft.Automation/automationAccounts/', parameters('omsAutomationAccountName'), '/runbooks/', variables('assets').runbooks.vmManagement.name)]"
            ],
            "plan": {
                "name": "[variables('omsSolutions').customSolution.solutionName]",
                "product": "[variables('omsSolutions').customSolution.name]",
                "publisher": "[variables('omsSolutions').customSolution.publisher]",
                "promotionCode": ""
            },
            "properties": {
                "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('omsWorkspaceName'))]",
                "referencedResources": [
                    "[resourceId('Microsoft.Automation/automationAccounts/variables/', parameters('omsAutomationAccountName'), variables('assets').aaVariables.AzureSubscriptionId.name)]",
                    "[resourceId('Microsoft.Automation/automationAccounts/variables/', parameters('omsAutomationAccountName'), variables('assets').aaVariables.OMSWorkspaceId.name)]",
                    "[resourceId('Microsoft.Automation/automationAccounts/variables/', parameters('omsAutomationAccountName'), variables('assets').aaVariables.OMSWorkspaceKey.name)]"
                ],
                "containedResources": [
                    "[resourceId('Microsoft.Automation/automationAccounts/runbooks/', parameters('omsAutomationAccountName'), variables('assets').runbooks.vmManagement.name)]",
                    "[resourceId('Microsoft.Automation/automationAccounts/modules/', parameters('omsAutomationAccountName'), variables('assets').psModules.ingestionAPI.name)]",
                    "[resourceId('Microsoft.OperationalInsights/workspaces/views/', parameters('omsWorkspaceName'), variables('omsSolutions').customSolution.name)]"
                ]
            }
        }
    ],
    "outputs": {}
}